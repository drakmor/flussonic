-module(h264_tests).
-compile(export_all).

-include_lib("eunit/include/eunit.hrl").
-include("../include/h264.hrl").

depacketize_test() ->
  ?assertEqual([<<0:3, ?NAL_SPS:5>>, <<0:3, ?NAL_IDR:5, 1,2,3,4,5,6>>, <<0:3, ?NAL_SINGLE:5, 1,2,3,4,5,6>>], h264:depacketize(rtp_test_fua())).

%  <<0:1, _NRI:2, ?NAL_FUA:5, Start:1, End:1, R:1, Type:1,  _Rest/binary>>

rtp_test_fua() ->
  [<<0:3, ?NAL_STAP_A:5, 1:16, 0:3, ?NAL_SPS:5>>, 
    <<0:3, ?NAL_FUA:5, 1:1, 0:1, 0:1, ?NAL_IDR:5, 1,2>>,<<0:3, ?NAL_FUA:5, 0:1, 0:1, 0:1, ?NAL_IDR:5, 3,4>>, <<0:3, ?NAL_FUA:5, 0:1, 1:1, 0:1, ?NAL_IDR:5, 5,6>>,
    <<0:3, ?NAL_FUA:5, 1:1, 0:1, 0:1, ?NAL_SINGLE:5, 1,2>>,<<0:3, ?NAL_FUA:5, 0:1, 0:1, 0:1, ?NAL_SINGLE:5, 3,4>>, <<0:3, ?NAL_FUA:5, 0:1, 1:1, 0:1, ?NAL_SINGLE:5, 5,6>>
    ].


parse_422_sps_test() ->
  ?assertMatch(#h264_sps{profile = 122, level = 31, width = 1280, height = 720}, 
    h264:parse_sps(<<103,122,0,31,188,217,64,80,5,187,1,16,0,0,62,144,0,11,184,0,241,131,25,96>>)).


parse_sps_for_high_profile_test() ->
  ?assertMatch(#h264_sps{profile = 100, level = 50, width = 1280, height = 720}, h264:parse_sps(<<103,100,0,50,172,52,226,192,80,5,187,1,16,0,0,62,144,0,11,184,8,241,131,24,184>>)).

parse_sps_for_low_profile_test() ->
  ?assertMatch(#h264_sps{profile = 77, level = 51, width = 512, height = 384}, h264:parse_sps(<<103,77,64,51,150,99,1,0,99,96,34,0,0,3,0,2,0,0,3,0,101,30,48,100,208>>)).

parse_sps_for_rtsp_test() ->
  ?assertMatch(#h264_sps{profile = 66, level = 20, width = 352, height = 288}, h264:parse_sps(<<103,66,224,20,218,5,130,81>>)).

parse_sps_40_level_test() ->
  ?assertMatch(#h264_sps{profile = 100, level = 40, width = 640, height = 480}, h264:parse_sps(<<103,100,0,40,173,0,206,80,40,15,108,4,64,
                                       0,3,132,0,0,175,200,56,0,0,48,0,0,3,0,11,
                                       235,194,98,247,227,0,0,6,0,0,3,0,1,125,
                                       120,76,94,252,27,65,16,137,75>>)).

parse_sps_with_crop_test() ->
 ?assertMatch(#h264_sps{profile = 66, level = 40, width = 1920, height = 1080}, h264:parse_sps( <<103,66,240,40,145,176,30,0,137,249,112,22,224,32,32,40,
    0,0,31,72,0,6,26,132,32,0,0,0,0>>)).

parse_sps1_test() ->
  ?assertMatch(#h264_sps{width = 1920, height = 1080}, h264:parse_sps(<<103,77,0,41,154,102,3,192,17,62,94,
    2,212,4,4,5,0,0,3,3,232,0,0,195,80,232,101,5,11,188,184,208,202,10,23,121,112,160,0>>)).


sps_100_level() ->
  <<39,100,0,31,173,136,14,67,152,32,225,12,41,10,68,7,33,204,16,112,134,20,133,
    34,3,144,230,8,56,67,10,66,144,192,66,24,194,28,102,50,16,134,2,16,198,16,
    227,49,144,132,48,16,134,48,135,25,140,132,34,2,17,152,206,35,194,159,17,248,
    143,226,63,17,241,30,51,136,196,68,66,129,8,140,71,17,226,62,79,196,127,39,
    228,248,143,17,196,100,136,180,7,128,183,96,42,144,0,0,3,0,16,0,0,3,3,198,4,
    0,4,196,176,0,19,18,203,222,248,94,17,8,212>>.
    
parse_sps_100_level_test() ->
  ?assertMatch(#h264_sps{profile = 100, level = 31, sps_id = 0, width = 960, height = 720}, h264:parse_sps(sps_100_level())).

unpack_config_1_test() ->
  Config = <<1,66,192,21,253,225,0,23,103,66,192,21,146,68,15,4,127,88,8,128,0,1,244,0,0,97,161,71,139,23,80,1,0,4,104,206,50,200>>,
  Result = [<<103,66,192,21,146,68,15,4,127,88,8,128,0,1,244,0,0,97,161,71,139,23,80>>, <<104,206,50,200>>],
  LengthSize = 2,
  ?assertEqual({LengthSize, Result}, h264:unpack_config(Config)).

unpack_config_2_test() ->
  Config = <<1,77,64,30,255,224,0>>,
  ?assertEqual({4, []}, h264:unpack_config(Config)).

unpack_config_3_test() ->
  Config = <<1,66,224,11,255,225,0,19,39,66,224,11,169,24,96,157,128,53,6,1,6,182,194,181,239,124,4,1,0,4,40,222,9,136>>,
  ?assertEqual({4,[<<39,66,224,11,169,24,96,157,128,53,6,1,6,182,194,181,239,124,4>>, <<40,222,9,136>>]}, h264:unpack_config(Config)).

unpack_config_4_test() ->
  Config = <<1,77,0,21,3,1,0,35,103,77,64,21,150,82,130,131,246,2,161,0,0,3,3,232,0,0,156,64,224,96,3,13,64,
             0,73,62,127,24,224,237,10,20,139,1,0,5,104,233,9,53,32>>,
  ?assertEqual({4,[<<103,77,64,21,150,82,130,131,246,2,161,0,0,3,3,232,0,0,156,64,224,96,3,13,64,
                0,73,62,127,24,224,237,10,20,139>>,<<104,233,9,53,32>>]},h264:unpack_config(Config)).


%% Broken avcC in #147
unpack_config_5_test() ->
  Config = <<1,100,0,31,255,
  225,0,23,103,100,0,31,172,217,65,224,142,192,68,0,0,15,164,0,2,238,2,60,96,198,88,
  1,0,6,104,235,225,179,200,240,253,248,248,0>>,
  ?assertEqual({4, [<<103,100,0,31,172,217,65,224,142,192,68,0,0,15,164,0,2,238,2,60,96,198,88>>,<<104,235,225,179,200,240>>]}, 
    h264:unpack_config(Config)).





